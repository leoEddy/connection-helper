name: Words Watch (email on failure)

on:
  schedule:
    - cron: "15 08 * * *"   # PST 12:15am
    - cron: "15 07 * * *"   # PDT 12:15am
  workflow_dispatch: {}

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Check Last-Modified of words.txt
        shell: bash
        run: |
          set -euo pipefail
          RAW_URL="https://raw.githubusercontent.com/leoEddy/connection-helper/refs/heads/main/wordzz.txt"
          HDRS="$(curl -sI "$RAW_URL")" || { echo "::error ::Failed to fetch headers"; exit 1; }
          LM="$(printf '%s\n' "$HDRS" | awk -F': ' 'tolower($1)=="last-modified"{print $2}' | tr -d '\r')"

          if [[ -z "${LM:-}" ]]; then
            echo "::error ::No Last-Modified header (network/URL issue)."
            exit 1
          fi

          LM_PT="$(TZ=America/Vancouver date -d "$LM" '+%Y-%m-%d %H:%M')"
          FILE_DAY_PT="$(TZ=America/Vancouver date -d "$LM" '+%Y-%m-%d')"
          TODAY_PT="$(TZ=America/Vancouver date '+%Y-%m-%d')"

          echo "Last-Modified (PT): $LM_PT"

          if [[ "$FILE_DAY_PT" != "$TODAY_PT" ]]; then
            echo "::error ::words.txt NOT updated today. Last (PT): $LM_PT"
            exit 1   # ❌ triggers GitHub email/push
          fi

          echo "✅ words.txt is up to date for today."
